---
title: 浏览器的数据存储方案
tags:
  - 浏览器
categories: 浏览器
top: false
copyright: true
date: 2018-04-11 14:03:07
---

浏览器在提供了8种数据存储的技术，包括HTTP文件缓存、LocalStorage、 sessionStorage、cookie、indexDB、webSQL 、CatheStorage、Application Cathe。对这几种方案需要熟悉。通常不同的网站，数据存储于不同的区域，并且一个网站只能访问自身的数据，BTW，数据访问不能跨域,不同的网站不能使用相同的数据库
<!--more-->

## localStorage方式
localStorage存储的数据没有时间限制，不会失效；在当前域下都可以直接获取                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                

```js
//添加或修改
window.localStorage.setItem("name","zhyjor")
//获取
alert(window.localStorage.getItem("name"));
//删除
window.localStorage.removeItem(name)
//清空
window.localStorage.clear();

//也可与通过数组和“.”操作符来添加和获取
window.localStorage.name;
window.localStorage["name"]

//使用key()获取键的集合
 for(var i=0;i < window.localStorage.length;i++){
   var key=window.localStorage.key(i);
   console.log(key);
 }


```
**注意：**

* localStorage只支持string类型的存储。无论存储的是什么数据结构，取出的都是string，Json数据需要经过stringfy（）转换。读取的时候需要解析parse()
* 官方推荐的是getItem\setItem这两种方法对其进行存取
* localStorage拓展了cookie的4K限制,相当于一个5M大小的针对于前端页面的数据库。
* localStorage不能被爬虫抓取到
* IE8以上的IE版本才支持localStorage这个属性
* 不同浏览器无法共享localStorage或sessionStorage中的信息。相同浏览器的不同页面间可以共享相同的localStorage（页面属于相同域名和端口）

##  sessionStorage 方法
localStorage与sessionStorage的唯一一点区别就是localStorage属于永久性存储，而sessionStorage属于当会话结束的时候，sessionStorage中的键值对会被清空。

sessionStorage 方法针对一个 session 进行数据存储。当用户关闭浏览器窗口后，数据会被删除。

两者的方法相同！

### storage事件
当储存的数据发生变化时，会触发storage事件。我们可以指定这个事件的回调函数。

<pre><code>
window.addEventListener("storage",function onStorageChange(event) {  
     console.log(event.key);      
});  
</code></pre>

event一个有四个属性

* key:发生变化的键名
* oldValue:更新前的值。如果该键为新增加，则这个属性为null
* newValue:更新后的值。如果该键被删除，则这个属性为null。 
* url：原始触发storage事件的那个网页的网址。 



监听storage变更事件会发现，当数据发生变化时本页是监听不到storage事件变更消息的。而同域的其他打开的页面反而监听到了该消息。**该事件不在导致数据变化的当前页面触发**。一个页面改变sessionStorage或localStorage的数据时，同域的其他打开的页面的storage事件会被触发，而原始页面并不触发storage事件。可以通过这种机制，**实现多个窗口之间的通信**。IE浏览器除外，它会在所有页面触发storage事件。

### storage事件当前界面捕获

如何在当前页响应这些修改数据库的事件呢？

当前页面获取storage这个是有必要的，尤其是在**单页面（SPA应用）开发时**，这种限制几乎是致命的。单页面应用只在一个页面中渲染不同的内容，因此我们需要重写localStorage的方法来达到可以监听自己本身页面修改的效果。

此时我们需要重写localStorage的方法，并设置自定义的事件

```js
var orignalSetItem = localStorage.setItem;
localStorage.setItem = function(key,newValue){
    var setItemEvent = new Event("setItemEvent");
    setItemEvent.newValue = newValue;
    window.dispatchEvent(setItemEvent);
    orignalSetItem.apply(this,arguments);
}
window.addEventListener("setItemEvent", function (e) {
    alert(e.newValue);
});
localStorage.setItem("nm","1234");
```



## Cookies方式
cookie数据始终在同源的http请求中携带，cookie在浏览器和服务器之间进行传递，cookie的数据还有path的概念，可以限制cookies只属于某个路径下，cookie数据不能超过4k，同时因为每次http请求都会携cookie，所以cookie只适合保存很小的数据，如会话标识。


### 比较三者的不同

cookie，localStorage，sessionStorage都可以实现客户端存储，三者的区别有哪些了？

**从出现目的看**
* cookie作为最早期的被设计web浏览器存储少量数据，从底层看，它是作为http协议的一种扩展实现。cookie数据会自动在web浏览器和web服务器之间传输数据。
* localStorage, sessionStorage是HTML5中新增的web存储的功能，它解决了客户端存储的一些缺点，并提供更强大的功能和操作API。

**从有效时间看**
* cookie有效期：cookie默认有效期非常短暂，存在于web浏览器会话期间，当浏览器关闭，cookie也就消失了。如果要延长cookie的有效期，可以设置max-age属性（单位秒）
* localStorage有效期：永不失效，除非web应用主动删除。
* sessionStorage有效期：sessionStorage的有效期是和存储数据脚本所在的最顶层的窗口或者是浏览器标签是一样的，一旦窗口或者标签页被永久关闭了，存储的数据也就失效了。

**从作用域看**
* cookie作用域：cookie作用域是通过domain文档源和path文档路径来确定的。默认情况下，cookie和创建它的web页面有关，并对web页面和该web页面同目录或者子目录的其他web页面可见。当设置path="/"，它的作用域就变成文档源级别的了。
* localStorage作用域：localStorage的作用域是限定在文档源级别的。文档源通过协议、主机名以及端口三者来确定。
* sessionStorage作用域：sessionStorage的作用域也是限定在文档源级别。但需要注意的是，如果相同文档源的页面渲染在不同的标签中，sessionStorage的数据是无法共享的。


除了上述列举的，cookie和localStorage、sessionStorage在存储大小的限制也不一样， 由于每个浏览器的实现标准都不一样，只说一下RFC 2965推荐标准（浏览器保存cookie不超过300个，为每个服务器保存的cookie不超过20个，每个cookie大小不超过4KB）。localStorage、sessionStorage设置值时可以达到8M。Web Storage拥有setItem,getItem,removeItem,clear等方法，不像cookie需要前端开发者自己封装setCookie,getCookie。

document.cookie可以读取到cookie, **但是读取不到带有HTTPOnly 的参数的cookie，只能传输给服务器读写，这样就防止了前端的篡改**，比如说：

document.cookie 的操作比webStorage麻烦的多，它是由等号和分号分隔开的字符串；

## HTTP文件缓存
对于浏览器缓存参见[《http协议详解之一：缓存》]()

## webSQL
最新chrome才支持；


## indexDB

进行大数据的存储，通常50m, 目前应用场景都不多，放太多东西在本地会造成数据的泄露；

## Application Cache 

通过配置manifest 文件选择性的在本地存储，
当浏览器第二次打开页面的时候，会优先从 applictionCache 来加载，然后检查  app.manifest 是否更新，如果有更新则拉取更新文件并且更新app.manifest;

```html
<!DOCTYPE html>
<html lang="en" manifest="app.manifest">
<head>
<meta charset="UTF-8">
<title>Document</title>
<link rel="stylesheet" href="test.css">
</head>
<body>
<script src = 'test.js'></script>
</body>
</html>
```
/ app.manifest

```
CHACHE MANIFEST
#VERSION 1.0
CHACHE
test.css
test.js
```

**Application Cache 被标准弃用，浏览器不兼容， 不成熟, 被serviceWorkers 替代**

## cacheStorage

用来替代Application cache的解决方案；通过window.caches 可以获取到Caches 对象，api 是下面的：

```js
window.caches.open() // 打开一个caches对象并且返回promise 对象；
window.caches.has( ) //检查如果包含一个caches对象，则返回promise对象；
window.caches.delete()
window.caches.key()
window.caches.metch()
```

cacheStorage 是基于serviceWorker, serviceWorker是在后台独立线程运行的js脚本，通过 message/ postmessage 方法与页面进行通信；
 
但是短期内兼容性还是很差的；
 
所以，目前可以用的只有 HTTP缓存，localStorage 和cookie了；




**参考资料**
[5分钟带你学习浏览器8大数据存储技术](https://www.cnblogs.com/dujuncheng/p/6850246.html)

![](http://oankigr4l.bkt.clouddn.com/wexin.png)
---
title: 浏览器与前端开发之一：跨域与跨域访问
tags:
  - 浏览器与前端开发
  - 跨域
  - 浏览器
categories: 浏览器
top: false
copyright: true
date: 2018-01-15 16:31:32
---
前端开发中跨域是一个绕不过的问题，跨域的方法也是千奇百怪。无论是名门正派还是奇技淫巧，这里都整理一下，方便后续的查阅。
<!--more-->
## 先考虑几个问题：
**Q:为什么会有跨域问题**
> A:浏览器的同源策略限制，浏览器会拒绝跨域请求。

在web的交互环境中，只能保证请求发自某个用户的浏览器，但是不能保证请求本身就是用户自愿发出的。这个时候就就有构造跨站请求伪造（CSRF）可能，这里利用的就是网站对浏览器的信任。
 **严格来说，浏览器并不是拒绝所有的跨域请求，它拒绝的其实是跨域的读操作。浏览器的同于策略是这样执行的：**
 * 浏览器允许跨域写操作（Cross-origin writes）,如链接，重定向
 * 浏览器允许跨域资源嵌入（Cross-origin embedding）,如img，script标签
 * 浏览器不允许跨域读操作（Cross-origin reads）


**Q:什么情况算跨域**
> A:非同源请求，均为跨域。

**Q:为什么有跨域需求**
> A:工程服务化后，不同职责的服务分散在不同的工程中，这些工程的域名往往是不同的，但是一个需求可能需要对应到多个服务，这时便需要调用不同服务的接口，因此会出现跨域。

## 跨站请求伪造（CSRF）
CSRF攻击的主要目的是让用户在不知情的情况下攻击自己已登录的一个系统，类似于钓鱼。如用户当前已经登录了邮箱，或bbs，同时用户又在使用另外一个，已经被你控制的站点，我们姑且叫它钓鱼网站。这个网站上面可能因为某个图片吸引你，你去点击一下，此时可能就会触发一个js的点击事件，构造一个bbs发帖的请求，去往你的bbs发帖，由于当前你的浏览器状态已经是登陆状态，所以session登陆cookie信息都会跟正常的请求一样，纯天然的利用当前的登陆状态，让用户在不知情的情况下，帮你发帖或干其他事情。

## 同源策略
同源指两个页面拥有相同的协议（protocol）、端口（port）和主> 机（host），那么这两个页面属于同一个源（origin）

![](http://oankigr4l.bkt.clouddn.com/201805151744_850.png)

**同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。**

## 跨域访问
如何实现跨域呢？
### 通过document.domain跨域
这个一般父子域才会使用。如果是子域名下的页面想访问父域的api，那可以在发请求前设置一下document.domain的值为父域，毕竟是子域，浏览器几乎没有做什么限制。

### 通过location.hash跨域

### 通过HTML5的postMessage方法跨域

### 通过jsonp跨域
#### jsonp的本质
JSONP本质上就是让数据变成js代码，使用script标签来加载数据。

如我的用户数据api本来是
```
https://www.x.com/api/v4/members/jack
```
返回值为
```
{"name": "jack", "gender": 1}
```

想要通过JSONP实现在y.x.com下跨域拿到这个数据，这个时候明显需要跨域，而且是非父子域，需要做的是：
* 改造这个api，让他返回一段js,而不是json数据
 ```
可以修改为如果你访问：
https://www.x.com/api/v4/members/jack?callback=render
得到的响应为：
render({"name": "jack", "gender": 1})
	```
* 在数据使用页面，不使用ajax去拿取数据，而是嵌入一个script标签：
```
<script src="https://www.x.com/api/v4/members/jack?callback=render"></script>
 ```
* 在数据使用页面写好一个叫render的函数，用来渲染用户数据

因为浏览器并不限制script标签的src是要从哪里加载脚本，跨域问题似乎就被JSONP「绕过」了。

#### JSONP的限制
再想一想，浏览器不做script来源的跨域限制，而且大家都喜欢用JSONP并且改造了大量的api响应，问题不是回到了原点吗？我有一个网站a.com，在里面嵌入了支付宝某个api的JSONP版本（也就是个script）；我骗你访问a.com；浏览器自动去加载script，也就去访问了这个api。

其实问题并没有回到原点，因为JSONP实际上受限很大。作为一个script标签，
* 一是浏览器只会使用GET方法去请求它
* 二是请求它的时候不会携带cookie
* 三是能被改造成JSONP形式的api一定是纯粹用来GET数据的。

就算其他网站用这些JSONP改造过的接口，也不会对网站造成影响。

**所以后端开发者最好不要在GET操作里做非幂等的事，因为别人在他的网站里嵌入script或者img标签放你网站的url，浏览器就会发出一个不带cookie的GET请求。**

但是前段开发中，总有场景需要复杂的跨域需求。比如我就是需要在y.x.com页面下，发post请求到www.x.com域名下的api，而且还是要带cookie的。这时JSONP就完全用不上了。

### 通过CORS跨域
JSONP更像一种hack，是一种非标准行为，利用了script标签来做数据的事情，并且JSONP的使用使得别人可以在他自己的网站上使用你的数据（当然假如别人使用后端代理的手段还是可以的）。

对于跨域的访问控制，是有HTTP标准的。这也是网上很多讲跨域的文章的主要内容，我就只简单介绍，跨域资源共享（CORS）把跨域行为分三类：简单请求、预检请求、带cookie的请求

#### 简单请求
如简单的GET和POST。

还是以y.x.com页面请求www.x.com的api为例。
* 浏览器发出请求时，request里会带上Origin头，值为y.x.com
* 这时只需要api响应header里带的`Access-Control-Allow-Origin`字段包含（匹配）了发送请求的页面所在的域名（y.x.com），浏览器就会认为合法，把数据接着使用。
* 否则，浏览器会拦截掉这段数据：没错，响应的数据已经放body里到达了客户端，而浏览器会阻止掉，让专栏页面里负责发ajax的那段js代码拿不到响应值。

这样的好处很明显：我只需要在服务器端（通常是网关这一层）配置好Access-Control-Allow-Origin，而我的代码逻辑不需要对来源站点区别对待，就阻止其他人纯前端的手段使用我的数据，做到HTTP访问控制。

#### 预检请求
略微复杂一定的请求，如PUT和DELETE等，或者请求时添加了CORS安全的header之外的header（如自定义的）。

这时，正式发送跨域请求前，浏览器会先对目标api发出一个OPTIONS预检请求，这个请求里会带三个和跨域相关的header，其值为预检之后，正式发送api请求时将会使用的来源/方法/请求头。这三个header是：
* Origin
* Access-Control-Request-Method
* Access-Control-Request-Headers

看名称应该能大概知道对应什么了。预检请求的响应需要带着与它们对应匹配的header和值，这样浏览器才会去请求跨域api。

预检请求的出现，是因为PUT等复杂操作通常是非幂等的。如果像简单请求一样直接请求，发现响应不合理才去拦截响应值，这个时候后端的PUT操作里该执行的事情已经被执行过了。

**至于为什么POST这个非幂等语义的方法会是简单请求，我觉得应该是历史包袱。毕竟在CORS出现前，form表单里POST就是能跨域使用的。而早期的js很弱小，提交form之后页面会刷新跳转到目标地址，源地址是拿不到POST响应的数据的**

#### 带cookie的请求
这种跨域请求才是最危险的，最严重情况下能实现上面举的支付宝转账例子。

所以这种请求要求响应头里`Access-Control-Allow-Credentials`为true，且`Access-Control-Allow-Origin`不能是通配符，防止后端开发者犯错。

关于CORS更具体的规则，可以在MDN查阅到详细的资料。


### 通过window.name跨域
> window对象有个name属性，该属性有个特征：即在一个窗口(window)的生命周期内,窗口载入的所有的页面都是共享一个window.name的，每个页面对window.name都有读写的权限，window.name是持久存在一个窗口载入过的所有页面中的，并不会因新页面的载入而进行重置。


## 总结
除了跨域，还需要注意点击劫持等行为

**参考资料**
[JS中的跨域问题](https://juejin.im/post/5ab218b1518825555c1d8a11)
[Ajax 跨域难题 - 原生 JS 和 jQuery 的实现对比](https://juejin.im/post/5b28bbf5f265da59a836464d)
[为什么给你设置重重障碍？讲一讲Web开发中的跨域](https://zhuanlan.zhihu.com/p/39466226)

![](http://oankigr4l.bkt.clouddn.com/wexin.png)
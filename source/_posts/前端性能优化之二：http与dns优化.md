---
title: 前端性能优化之二：网络优化（http的设置）
tags:
  - 前端性能优化
categories: 前端性能
top: false
copyright: true
date: 2018-02-06 12:15:23
---
网络优化是大有可为的，比如使用缓存、http传输压缩、减少http请求数目，以及dns发散与dns收敛的不同作用等等。
<!--more-->
## 使用缓存
浏览器在第一次访问页面时向服务器请求资源，并缓存起来，下次再访问时会判断在缓存中是否已有该资源且有没有更新过，如果已有该资源且未更新过，则直接从浏览器缓存中读取。关于缓存可看另外一篇文章[《http协议详解之一：缓存（熟悉的304）》](https://zhyjor.github.io/2018/01/11/http%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%B9%8B%E4%B8%80%EF%BC%9A%E7%BC%93%E5%AD%98%EF%BC%88%E7%86%9F%E6%82%89%E7%9A%84304%EF%BC%89/)。

已缓存资源不再发起http请求，即HTTP的Expires和Cache-Control。对一个网站而言，CSS、JavaScript、图片等静态资源更新的频率都比较低，而这些文件又几乎是每次HTTP请求都需要的，如果将这些文件缓存在浏览器中，可以极好的改善性能。通过设置http头中的cache-control和expires的属性，可设定浏览器缓存，将静态内容设为永不过期，或者很长时间后才过期。

## http传输压缩
我们在将css，js，图片等资源部署是会将文件压缩，比如js文件和css，会将空格，注释等信息完全删除掉。对http传输的压缩和这些压缩的目的相同，都是为了减少文件下载的时间，但是两者相互没有影响。

从HTTP1.1开始，客户端可以通过Accept-Encoding头来声明浏览器支持的压缩方式，服务端通过content-Encoding来启用压缩，配置压缩的文件类型，压缩方式。当客户端的请求到达服务器，服务器对资源进行压缩后，返回给客户端，客户端按照相应的方式进行解析。

```
客户端（HTTP请求头）——accept-encoding: gzip, deflate, sdch, br
服务器（HTTP响应头）——content-encoding:gzip

文件传输前的大小——通过属性查看
文件传输过程中的大小——通过Network中的Size查看
```
**gzip是GUNzip的缩写，使用无损压缩，压缩效果最佳，已经成为使用最为普遍、支持的浏览器最多的数据压缩格式。天猫、淘宝、京东、苏宁、腾讯、百度等大型网站都使用gzip压缩方式。**

客户端不用做任何配置，在服务端配置即可，不同服务器的配置方法也不尽相同。这种配置的好处是减少HTTP响应时间，提升传输效率，当然也有也负面影响：压缩过程占用服务器额外的CPU周期，客户端也要对压缩文件进行解压缩，这也需要占用部分时间。随着硬件性能不断提高，上述问题正在不断弱化，国内外大型网站都对HTTP传输进行压缩。

## 减少http的请求数
这个应该已经不是什么大的问题了
* 图片地图允许在一个图片上关联多个URL，目标URL取决于用户单击的图片上的位置。
* CSS Sprites，CSS精灵，合并图片，通过指定CSS的backgroud-image和backgroud-position来显示元素。
* 合并JS脚本和CSS样式表
* 在用户不带缓存访问页面的时候，内联所有的js和css的效率更快，原因是外置js和css带来额外的http请求开销，1个http请求相对于3个http请求要更快一些。
其实，使用外部JS和CSS文件会产生更快的访问速度，这是由于外部JS和CSS文件能被浏览器缓存，当下次再请求相同的JS和CSS时，浏览器将不会再发出HTTP请求，而是使用缓存的JS和CSS文件，减少了HTTP请求数。

## CDN内容分发网络
CDN是一组分布在多个不同地理位置的Web服务器，用于更加有效地向用户发布内容，在优化性能时，会根据距离的远近来选择。

CDN将网站的资源发布到离用户最近的网络边缘，用户可以就近取得资源内容。

CDN通常部署静态内容：JavaScript脚本、CSS样式表、图片、图标、Flash等，不包括html页面。

浏览器是根据域(Domain)来缓存内容资源的，只要域(Domain)不一样，那么即使是同一个资源，也需要重复下载，且使用同样的方式缓存起来，这需要需要占用带宽和本地缓存空间。

###  如何优化
**将静态资源缓存到离用户很近的相同网络运营商的CDN节点上**
如果服务器离用户更近，则HTTP请求和响应时间将缩短。

不同地区的用户访问同一个域名能得到不同CDN节点的IP地址，这要依赖于CDN服务商提供的智能DNS服务，浏览器发起域名查询时，智能DNS服务会根据用户IP计算并返回离它最近的相同网络运营商的CDN节点IP。

通过智能DNS服务获取最近的相同网络运营商的CDN节点IP后，不同地区的用户会向离自己最近的相同网络运营商的CDN节点发起请求，当请求达到CDN节点后，节点会判断自己的内容缓存是否有效，一个地区内只要有一个用户先加载资源，就会在CDN中建立缓存，该地区的其他后续用户都能直接读取缓存数据。

**加载静态资源使用与页面不同的域名（不是用独立的二级或三级域名，而是用独立的一级域名）**
静态资源和主页面不同域，加载静态资源的HTTP请求就不会带上主页面中的cookie等数据，减少了数据传输量，节省流量，提升上传效率。

## cookie优化
cookie存储在客户端，伴随着HTTP请求在浏览器和服务器之间传递。除了key-value外，cookie还有max-age，path，domain和httponly属性。

**参考资料**
[浅谈前端性能优化（六）——CDN内容分发网络](https://blog.csdn.net/zhouziyu2011/article/details/71335350)

![](http://oankigr4l.bkt.clouddn.com/wexin.png)